name: IArchitecture Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.cs'
      - '**.java'
      - '**.py'
      - '**.js'
      - '**.ts'
      - '**.cpp'
      - '**.cu'
      - '**.cuh'
  push:
    branches:
      - main
      - master

jobs:
  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger and Wait for DemoRepo Validation
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.IARCHITECTURE_PAT }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prHeadRef = context.payload.pull_request.head.ref;
            const prBaseRef = context.payload.pull_request.base.ref;

            console.log(`Triggering validation for PR #${prNumber}`);

            // Trigger workflow_dispatch in DemoRepo
            const triggerResponse = await github.rest.actions.createWorkflowDispatch({
              owner: 'theIArchitecture',
              repo: 'DemoRepo',
              workflow_id: 'iarchitecture-validation.yml',
              ref: 'main',
              inputs: {
                pr_number: prNumber.toString(),
                pr_head_ref: prHeadRef,
                pr_base_ref: prBaseRef
              }
            });

            console.log('Validation triggered, waiting for workflow to start...');

            // Wait for workflow run to appear (GitHub takes a moment to create it)
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Poll for the workflow run
            let workflowRun = null;
            let attempts = 0;
            const maxAttempts = 60; // 5 minutes max (5 second intervals)

            while (attempts < maxAttempts) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: 'theIArchitecture',
                repo: 'DemoRepo',
                workflow_id: 'iarchitecture-validation.yml',
                event: 'workflow_dispatch',
                per_page: 10
              });

              // Find the run we just triggered (most recent)
              workflowRun = runs.data.workflow_runs.find(run =>
                run.status !== 'completed' ||
                (new Date() - new Date(run.created_at) < 60000) // within last minute
              );

              if (workflowRun && workflowRun.status === 'completed') {
                break;
              }

              if (workflowRun) {
                console.log(`Workflow status: ${workflowRun.status}`);
              }

              await new Promise(resolve => setTimeout(resolve, 5000));
              attempts++;
            }

            if (!workflowRun) {
              core.setFailed('Could not find triggered workflow run');
              return;
            }

            console.log(`Workflow completed with conclusion: ${workflowRun.conclusion}`);
            console.log(`View run: ${workflowRun.html_url}`);

            // Exit with appropriate status based on validation result
            if (workflowRun.conclusion === 'success') {
              console.log('✅ Validation passed - no architectural violations found');
            } else if (workflowRun.conclusion === 'failure') {
              core.setFailed('❌ Validation failed - architectural violations found. Check DemoRepo validation results.');
            } else if (workflowRun.conclusion === 'cancelled') {
              core.setFailed('⚠️ Validation was cancelled');
            } else {
              core.setFailed(`⚠️ Validation completed with unexpected status: ${workflowRun.conclusion}`);
            }

  trigger-full-scan:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Full Scan
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.IARCHITECTURE_PAT }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: 'theIArchitecture',
              repo: 'DemoRepo',
              event_type: 'code-push',
              client_payload: {
                ref: context.ref,
                repository: context.payload.repository.full_name,
                pusher: context.payload.pusher.name
              }
            });
            console.log(`Triggered code-push for ${context.ref}`);
